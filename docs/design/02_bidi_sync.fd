# FD v1
# Bidirectional Sync â€” data flow between text, graph, and canvas (R2.x)

style label {
  fill: #1A1A2E
  font: "Inter" 600 14
}

style desc {
  fill: #6B7280
  font: "Inter" 400 12
}

style box_primary {
  fill: #6C5CE7
  corner: 16
}

style box_green {
  fill: #10B981
  corner: 16
}

style box_orange {
  fill: #F59E0B
  corner: 16
}

# â”€â”€â”€ Title â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

text @title "Bidirectional Sync Architecture" {
  font: "Inter" 800 32
  fill: #1A1A2E
}

text @subtitle "R2: Text â†” SceneGraph â†” Canvas â€” all edits funnel through one graph" {
  font: "Inter" 400 16
  fill: #6B7280
}

# â”€â”€â”€ The three layers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

rect @fd_text {
  ## "FD Text â€” the .fd source file"
  ## accept: "line-oriented, git-friendly diffs"
  ## status: done
  ## tag: core
  w: 260 h: 140
  use: box_primary
  bg: #6C5CE7 corner=16 shadow=(0,4,20,#6C5CE740)

  group { layout: column gap=8 pad=24
    text "ğŸ“ .fd Text" { font: "Inter" 700 18; fill: #FFF }
    text "Human + AI editable" { font: "Inter" 400 13; fill: #E0DDFF }
    text "Parser â†’ SceneGraph" { font: "Inter" 400 13; fill: #E0DDFF }
  }

  anim :hover { scale: 1.04; ease: spring 300ms }
}

rect @scene_graph {
  ## "SceneGraph â€” single source of truth (DAG)"
  ## accept: "R2.4: conflict-free single authoritative graph"
  ## status: done
  ## priority: high
  w: 260 h: 140
  use: box_green
  bg: #10B981 corner=16 shadow=(0,4,20,#10B98140)

  group { layout: column gap=8 pad=24
    text "ğŸŒ SceneGraph" { font: "Inter" 700 18; fill: #FFF }
    text "DAG (petgraph)" { font: "Inter" 400 13; fill: #D1FAE5 }
    text "Single source of truth" { font: "Inter" 400 13; fill: #D1FAE5 }
  }

  anim :hover { scale: 1.04; ease: spring 300ms }
}

rect @canvas {
  ## "Canvas â€” GPU-rendered interactive view"
  ## accept: "R5.1: Vello + wgpu, 60 FPS"
  ## status: done
  w: 260 h: 140
  use: box_orange
  bg: #F59E0B corner=16 shadow=(0,4,20,#F59E0B40)

  group { layout: column gap=8 pad=24
    text "ğŸ¨ Canvas" { font: "Inter" 700 18; fill: #FFF }
    text "Vello + wgpu GPU render" { font: "Inter" 400 13; fill: #FEF3C7 }
    text "Visual drag/draw tools" { font: "Inter" 400 13; fill: #FEF3C7 }
  }

  anim :hover { scale: 1.04; ease: spring 300ms }
}

# â”€â”€â”€ Sync edges â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

edge @text_to_graph {
  ## "R2.2: Text â†’ Canvas: source edits re-render in <16ms"
  ## accept: "incremental re-parse, not full document"
  from: @fd_text
  to: @scene_graph
  label: "parse()"
  stroke: #6C5CE7 2
  arrow: end
  curve: smooth
}

edge @graph_to_text {
  ## "R2.1: Canvas â†’ Text: visual edits update source in <16ms"
  from: @scene_graph
  to: @fd_text
  label: "emit()"
  stroke: #8B5CF6 2
  arrow: end
  curve: smooth
}

edge @graph_to_canvas {
  ## "Layout solver resolves constraints â†’ absolute coords"
  from: @scene_graph
  to: @canvas
  label: "layout() + paint()"
  stroke: #10B981 2
  arrow: end
  curve: smooth
}

edge @canvas_to_graph {
  ## "User interactions (drag, resize) mutate graph directly"
  from: @canvas
  to: @scene_graph
  label: "tool events"
  stroke: #F59E0B 2
  arrow: end
  curve: smooth
}

# â”€â”€â”€ Performance requirements â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

group @perf_badges {
  ## "Non-functional requirements for sync latency"
  layout: row gap=16 pad=0

  rect @badge_parse {
    w: 160 h: 48
    fill: #F0EDFC
    corner: 24
    text "Parse: <16ms" { font: "Inter" 600 13; fill: #6C5CE7 }
  }

  rect @badge_render {
    w: 160 h: 48
    fill: #D1FAE5
    corner: 24
    text "Render: <16ms" { font: "Inter" 600 13; fill: #059669 }
  }

  rect @badge_roundtrip {
    w: 200 h: 48
    fill: #FEF3C7
    corner: 24
    text "Round-trip: <16ms" { font: "Inter" 600 13; fill: #D97706 }
  }
}

# â”€â”€â”€ Layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

@title -> center_in: canvas
@subtitle -> offset: @title 0, 50
@fd_text -> offset: @subtitle 0, 80
@scene_graph -> offset: @fd_text 320, 0
@canvas -> offset: @scene_graph 320, 0
@perf_badges -> offset: @fd_text 160, 220
